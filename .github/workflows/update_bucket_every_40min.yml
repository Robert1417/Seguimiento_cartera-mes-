name: Update Bucket Columns (cada 45m desde 8:45)

on:
  schedule:
    # Horarios en UTC (Bogotá = UTC-5)
    - cron: "45 13 * * *"  # 08:45
    - cron: "30 14 * * *"  # 09:30
    - cron: "15 15 * * *"  # 10:15
    - cron: "45 16 * * *"  # 11:45
    - cron: "30 17 * * *"  # 12:30
    - cron: "15 18 * * *"  # 13:15
    - cron: "45 19 * * *"  # 14:45
    - cron: "30 20 * * *"  # 15:30
    - cron: "15 21 * * *"  # 16:15
    - cron: "45 22 * * *"  # 17:45
    - cron: "30 23 * * *"  # 18:30

  workflow_dispatch: {}

# Evita ejecuciones simultáneas (si una se demora y arranca la otra)
concurrency:
  group: update-bucket-columns
  cancel-in-progress: true

jobs:
  run-updates-only:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies (with retries)
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip

          # Reintento por fallos intermitentes de red/PyPI
          for i in 1 2 3 4 5; do
            echo "Attempt $i installing deps..."
            pip install pandas gspread google-auth --retries 5 --timeout 60 && break
            if [ "$i" -eq 5 ]; then
              echo "Failed installing dependencies after retries."
              exit 1
            fi
            sleep $((2**i))
          done

      - name: Run sync (updates only)
        env:
          MI_JSON: ${{ secrets.MI_JSON }}
        run: |
          python sync_bucket_updates_only.py
