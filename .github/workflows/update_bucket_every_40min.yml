name: Update Bucket Columns (cada 45m desde 8:45)

on:
  schedule:
  # Horarios en UTC (Bogotá = UTC-5)
   - cron: "45 14 * * *"  # 09:45
   - cron: "45 15 * * *"  # 10:45
   - cron: "15 16 * * *"  # 11:15
   - cron: "35 17 * * *"  # 12:35
   - cron: "35 18 * * *"  # 13:35
   - cron: "15 19 * * *"  # 14:15
   - cron: "35 20 * * *"  # 15:35
   - cron: "25 21 * * *"  # 16:25
   - cron: "20 22 * * *"  # 17:20
   - cron: "0 23 * * *"   # 18:00
  workflow_dispatch: {}


concurrency:
  group: update-bucket-columns
  cancel-in-progress: true

jobs:
  run-updates-only:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies (with retries)
        shell: bash
        run: |
          set -e
          python -m pip install --upgrade pip

          for i in 1 2 3 4 5; do
            echo "Attempt $i installing deps..."
            pip install pandas gspread google-auth --retries 5 --timeout 60 && break
            if [ "$i" -eq 5 ]; then
              echo "Failed installing dependencies."
              exit 1
            fi
            sleep $((2**i))
          done

      # ✅ Convierte el secret JSON en un archivo y configura credenciales estándar
      - name: Prepare Google credentials file
        shell: bash
        env:
          MI_JSON: ${{ secrets.MI_JSON }}
        run: |
          set -euo pipefail

          # Verifica que exista (sin imprimirlo)
          if [ -z "${MI_JSON}" ]; then
            echo "MI_JSON secret is empty or not available."
            exit 1
          fi

          # Escribe el JSON a un archivo
          echo "$MI_JSON" > /tmp/gcp_sa.json

          # Validación rápida de que sea JSON válido (sin mostrar contenido)
          python - <<'PY'
          import json
          with open("/tmp/gcp_sa.json","r",encoding="utf-8") as f:
            json.load(f)
          print("Service account JSON: OK")
          PY

      - name: Run sync (updates only) with retries
        shell: bash
        env:
          # estándar para librerías de Google
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp_sa.json
          # por si tu script usa MI_JSON directamente
          MI_JSON: ${{ secrets.MI_JSON }}
        run: |
          set -euo pipefail

          # Reintenta por fallos temporales (429/503/timeouts)
          for i in 1 2 3 4; do
            echo "Attempt $i running sync..."
            python -u sync_bucket_updates_only.py && exit 0
            echo "Sync failed. Retrying..."
            sleep $((2**i))
          done

          echo "Sync failed after retries."
          exit 1
